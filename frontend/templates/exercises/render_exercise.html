{% extends "frontend/base.html" %}

{% block title %}Score Viewer | REA - Music Education{% endblock %}

{% block extra_css %}
<style>
    #score-container {
        width: 100%;
        overflow-x: auto;
        padding: 1rem;
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .control-panel {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .control-section {
        flex: 1;
        min-width: 200px;
    }
    
    .playing-controls {
        display: flex;
        gap: 0.5rem;
    }
    
    .playing-controls button {
        flex: 1;
    }
    
    .note-highlight {
        fill: #3b82f6;
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'exercise-dashboard' %}">Exercises</a></li>
            <li class="breadcrumb-item"><a href="{% url 'exercise-detail' exercise.id %}">Exercise #{{ exercise.id }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Score Viewer</li>
        </ol>
    </nav>

    <div class="card mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Interactive Score Viewer</h2>
            <span class="badge {% if exercise.category == 'pitch' %}bg-success{% else %}bg-primary{% endif %}">
                {{ exercise.get_category_display }}
            </span>
        </div>
        <div class="card-body">
            <div class="control-panel">
                <div class="control-section">
                    <h5>Playback Controls</h5>
                    <div class="playing-controls">
                        <button id="play-btn" class="btn btn-primary">
                            <i class="fas fa-play me-1"></i> Play
                        </button>
                        <button id="pause-btn" class="btn btn-secondary" disabled>
                            <i class="fas fa-pause me-1"></i> Pause
                        </button>
                        <button id="stop-btn" class="btn btn-danger" disabled>
                            <i class="fas fa-stop me-1"></i> Stop
                        </button>
                    </div>
                </div>
                
                <div class="control-section">
                    <h5>Tempo</h5>
                    <div class="d-flex align-items-center gap-2">
                        <input type="range" class="form-range" id="tempo-slider" min="40" max="208" step="4" value="120">
                        <span id="tempo-value" class="badge bg-primary">120 BPM</span>
                    </div>
                </div>
                
                {% if exercise.voices > 1 %}
                <div class="control-section">
                    <h5>Voice Display</h5>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="voice-option" id="all-voices" value="all" checked>
                        <label class="btn btn-outline-primary" for="all-voices">All Voices</label>
                        
                        {% for i in "x"|ljust:exercise.voices %}
                        <input type="radio" class="btn-check" name="voice-option" id="voice-{{ forloop.counter }}" value="{{ forloop.counter }}">
                        <label class="btn btn-outline-primary" for="voice-{{ forloop.counter }}">Voice {{ forloop.counter }}</label>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div id="score-container" class="mb-4">
                <!-- The score will be rendered here -->
            </div>
            
            {% if exercise.category == 'pitch' %}
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Practice Mode</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="assessment-mode">
                        <label class="form-check-label" for="assessment-mode">Enable Assessment Mode</label>
                    </div>
                    
                    <div id="assessment-controls" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> Assessment mode will listen to your microphone and provide real-time feedback on pitch accuracy.
                        </div>
                        
                        <button id="start-assessment" class="btn btn-success">
                            <i class="fas fa-microphone me-1"></i> Start Assessment
                        </button>
                        
                        <div id="assessment-results" class="mt-3" style="display: none;">
                            <h6>Current Assessment:</h6>
                            <div class="progress mb-2">
                                <div id="pitch-accuracy" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                            </div>
                            <p class="small text-muted">
                                <span id="accuracy-value">0%</span> pitch accuracy
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- VexFlow and audio libraries -->
<script src="https://cdn.jsdelivr.net/npm/vexflow@4.1.0/build/cjs/vexflow.js"></script>
<!-- Only load the MIDI player if we have a MIDI file -->
{% if exercise.midi %}
<script src="https://cdn.jsdelivr.net/npm/midi-player-js@2.0.16/build/MidiPlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.0/dist/soundfont-player.min.js"></script>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize VexFlow renderer
    const VF = Vex.Flow;
    const scoreContainer = document.getElementById('score-container');
    
    // Clear any existing content
    scoreContainer.innerHTML = '';
    
    // Create renderer and context
    const renderer = new VF.Renderer(scoreContainer, VF.Renderer.Backends.SVG);
    renderer.resize(800, 250);
    const context = renderer.getContext();
    
    "{% if exercise.vexflow %}"
    // Load VexFlow data from the server
    fetch('{{ exercise.vexflow.url }}')
        .then(response => response.json())
        .then(scoreData => {
            renderScore(scoreData);
        })
        .catch(error => {
            console.error('Failed to load score data:', error);
            scoreContainer.innerHTML = '<div class="alert alert-danger">Failed to load score data. Please check the VexFlow file format.</div>';
        });
    "{% else %}"
    // If no VexFlow data is available, display a placeholder
    scoreContainer.innerHTML = '<div class="alert alert-warning">No interactive score data available for this exercise.</div>';
    
    // If we have an SVG, display it
    "{% if exercise.svg %}"
    const svgImage = document.createElement('img');
    svgImage.src = '{{ exercise.svg.url }}';
    svgImage.classList.add('img-fluid');
    svgImage.alt = 'Exercise notation';
    scoreContainer.appendChild(svgImage);
    "{% endif %}"
    "{% endif %}"
    
    function renderScore(scoreData) {
        // This is a placeholder for the actual score rendering logic
        // In a real implementation, you would parse the VexFlow data
        // and render it using the VexFlow API
        
        // Example of a simple score (this would be replaced with the actual data)
        const stave = new VF.Stave(10, 10, 780);
        stave.addClef('treble').addTimeSignature('4/4');
        
        const notes = [
            new VF.StaveNote({ keys: ['c/4'], duration: 'q' }),
            new VF.StaveNote({ keys: ['d/4'], duration: 'q' }),
            new VF.StaveNote({ keys: ['e/4'], duration: 'q' }),
            new VF.StaveNote({ keys: ['f/4'], duration: 'q' })
        ];
        
        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.addTickables(notes);
        
        stave.setContext(context).draw();
        
        new VF.Formatter().joinVoices([voice]).format([voice], 500);
        voice.draw(context, stave);
    }
    
    // Initialize MIDI player
    "{% if exercise.midi %}"
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const tempoSlider = document.getElementById('tempo-slider');
    const tempoValue = document.getElementById('tempo-value');
    
    let player;
    let instrument;
    /*
    // Load MIDI player and SoundFont
    Soundfont.instrument(new AudioContext(), 'acoustic_grand_piano')
        .then(piano => {
            instrument = piano;
            
            // Initialize the player
            player = new MidiPlayer.Player(event => {
                if (event.name === 'Note on') {
                    instrument.play(event.noteName, 0, { gain: event.velocity / 100 });
                    
                    // Highlight the note in the score (this would require mapping MIDI events to score elements)
                    // highlightNote(event.noteNumber);
                }
            });
            
            // Load the MIDI file
            fetch('{{ exercise.midi.url }}')
                .then(response => response.arrayBuffer())
                .then(buffer => {
                    const midiFile = new Uint8Array(buffer);
                    player.loadArrayBuffer(midiFile);
                    
                    // Enable play button
                    playBtn.disabled = false;
                })
                .catch(error => {
                    console.error('Failed to load MIDI file:', error);
                });
        });
    */
    
    // Play button click handler
    playBtn.addEventListener('click', () => {
        player.play();
        playBtn.disabled = true;
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
    });
    
    // Pause button click handler
    pauseBtn.addEventListener('click', () => {
        player.pause();
        playBtn.disabled = false;
        pauseBtn.disabled = true;
    });
    
    // Stop button click handler
    stopBtn.addEventListener('click', () => {
        player.stop();
        playBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
    });
    
    // Tempo slider change handler
    tempoSlider.addEventListener('input', () => {
        const tempo = parseInt(tempoSlider.value);
        player.tempo = tempo;
        tempoValue.textContent = `${tempo} BPM`;
    });
    "{% endif %}"
    
    // Practice mode functionality
    "{% if exercise.category == 'pitch' %}"
    const assessmentModeSwitch = document.getElementById('assessment-mode');
    const assessmentControls = document.getElementById('assessment-controls');
    const startAssessmentBtn = document.getElementById('start-assessment');
    const assessmentResults = document.getElementById('assessment-results');
    const pitchAccuracyBar = document.getElementById('pitch-accuracy');
    const accuracyValue = document.getElementById('accuracy-value');
    
    assessmentModeSwitch.addEventListener('change', () => {
        assessmentControls.style.display = assessmentModeSwitch.checked ? 'block' : 'none';
    });
    
    startAssessmentBtn.addEventListener('click', () => {
        // This would integrate with the Web Audio API for pitch detection
        // For now, we'll just show a simulated result
        assessmentResults.style.display = 'block';
        
        // Simulate pitch detection
        let accuracy = 0;
        const interval = setInterval(() => {
            accuracy += 5;
            if (accuracy > 85) {
                clearInterval(interval);
            }
            
            pitchAccuracyBar.style.width = `${accuracy}%`;
            accuracyValue.textContent = `${accuracy}%`;
        }, 200);
    });
    "{% endif %}"
});
</script>
{% endblock %}